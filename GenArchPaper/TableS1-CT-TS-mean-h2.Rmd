---
title: "TableS1-CT-TS-mean-h2"
author: "Heather Wheeler"
date: "`r Sys.time()`"
output: html_document
---

```{r, echo=TRUE, message=FALSE, warning=FALSE}
  library(ggplot2)
  library(reshape2)
  library(dplyr)
  library(tidyr)
  library(GGally)
  library(grid)
  "%&%" = function(a,b) paste(a,b,sep="")
  source('/Volumes/im-lab/nas40t2/hwheeler/PrediXcan_CV/GTEx_2014-06013_release/transfers/PrediXmod/Paper_plots/multiplot.R')
  my.dir <- '/Volumes/im-lab/nas40t2/hwheeler/cross-tissue/'
  fig.dir <- '~/GitHub/GenArch/GenArchPaper/Figures/'
  rna.dir <- my.dir %&% "gtex-rnaseq/"
  annot.dir <- my.dir %&% "gtex-annot/"
  out.dir <- rna.dir %&% "ind-tissues-RPKM/"
  h2.dir <- my.dir %&% "gtex-h2-estimates/"
```

```{r, local.ts,eval=TRUE,fig.width=8,fig.height=8}
ct <- read.table(my.dir %&% 'cross-tissue.h2.all.models_FHSfdr0.05.Chr1-22_globaleQTLOtherChr_reml-no-constrain.2015-12-14.txt',header=T)
tislist <- scan(my.dir %&% '40.tissue.list',sep="\n",what="character")
table1 <- matrix(0,nrow=length(tislist)+1,ncol=7)
n <- ct$N[1]
numexpgenes <- dim(ct)[1] 
meanh2 <- signif(mean(ct$local.h2,na.rm=TRUE),3)
meanse <- signif(mean(ct$local.se,na.rm=TRUE),3)
ciest <-  ct %>% mutate(ymin = pmax(0, local.h2 - 2 * local.se), ymax = pmin(1, local.h2 + 2 * local.se)) %>% arrange(local.h2) %>% mutate(nonzeroCI=ymin>0,place=1:length(ct$tissue)) 
propsig <- signif(table(ciest$nonzeroCI)[2]/sum(table(ciest$nonzeroCI)),3)
numsig <- signif(table(ciest$nonzeroCI)[2],3)
table1[1,] <- c("Cross-tissue",n,meanh2,meanse,propsig,numsig,numexpgenes)


for(i in 1:length(tislist)){
  tis <- tislist[i]
  data <- read.table(my.dir %&% 'GTEx.TS.' %&% tis  %&% '.h2.all.models_FHSfdr0.05.Chr1-22_globaleQTLOtherChr_reml-no-constrain.2015-12-14.txt',header=T,sep="\t")  
  n <- data$N[1]
  numexpgenes <- dim(data)[1] ##num expressed genes mean(RPKM)>0.1
  meanh2 <- signif(mean(data$local.h2,na.rm=TRUE),3)
  meanse <- signif(mean(data$local.se,na.rm=TRUE),3)
  ciest <-  data %>% mutate(ymin = pmax(0, local.h2 - 2 * local.se), ymax = pmin(1, local.h2 + 2 * local.se)) %>% arrange(local.h2) %>% mutate(nonzeroCI=ymin>0,place=1:length(data$tissue)) 
  propsig <- signif(table(ciest$nonzeroCI)[2]/sum(table(ciest$nonzeroCI,useNA="i")),3)
  numsig <- signif(table(ciest$nonzeroCI)[2],3)
  tableinfo <- c(tis,n,meanh2,meanse,propsig,numsig,numexpgenes)
  table1[i+1,] <- tableinfo
}
colnames(table1)=c("tissue","n","mean h2","mean se","prop CI > 0","num CI > 0","num expressed")
#table1

library(xtable)
tab <- xtable(table1)
print(tab, type="latex",include.rownames=FALSE)
```


